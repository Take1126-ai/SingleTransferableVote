
# Python版 単記移譲式投票(STV)プログラム 設計書 (最終FIX版)

## 1. 基本設計

### 1.1. 概要
本プログラムは、選挙規約で定められた「ミーク法（ドループ基数固定版）」に基づき、単記移譲式投票（STV）の選挙シミュレーションを行う。コマンドラインからパラメータと投票データを指定し、厳密な選挙プロセスを経て当選者と落選者を決定する。

### 1.2. 主要処理フロー（ミーク法）
1.  **初期化とデータ読み込み:** `main`が引数を解析し、`SingleTransferableVote`クラスが投票データを読み込む。
2.  **ドループ基数計算:** `(有効投票総数 / (当選者数 + 1)) の整数部分 + 1` で計算。この値は選挙を通じて固定。
3.  **選挙ループ:** 当選者が定員に達するか、これ以上選挙を継続できなくなるまでラウンドを繰り返す。
    - **3-1. ラウンド実行:** 各ラウンドでは、まずミーク法の反復計算で全候補者の票を収束させる。
    - **3-2. 落選者決定:** 票が収束した後、活動中の候補者で最下位の者を落選させる。
4.  **最終当選者決定:** ループが終了した時点で、活動中の候補者のうち、最終得票数がドループ基数を**超えている者のみ**を当選者とする。

---

## 2. 詳細設計

### 2.1. `Candidate`クラス
| 属性名 | 型 | 説明 |
| :--- | :--- | :--- |
| `name` | `str` | 候補者名 |
| `votes` | `float` | 現在の得票数 |
| `is_winner` | `bool` | 当選フラグ |
| `is_loser` | `bool` | 落選フラグ |
| `keep_rate` | `float` | 保有率（ミーク法用） |

### 2.2. `Vote`クラス
| 属性名 | 型 | 説明 |
| :--- | :--- | :--- |
| `preferences` | `list[str]` | 選好リスト |

### 2.3. `SingleTransferableVote`クラス
| メソッド名 | 処理概要 |
| :--- | :--- |
| `run_election` | 選挙全体のプロセスを管理・実行する。 |
| `_run_main_loop` | 当選・落選が決まるまで選挙のラウンドを繰り返す。**残存候補者数が当選枠数になったら最終計算ラウンドに移行する。** |
| `_run_single_round` | 1回の選挙ラウンドを実行する。**ミーク法計算と落選者決定のみを行う。** |
| `_run_meek_iteration` | 保有率が収束するまで反復計算を行う。**規約の乗算式 `R_new = R_old * (Dr / V)` を正しく適用する。** |
| `_recalculate_votes` | 現在の保有率に基づき、全候補者の票をゼロから再計算する。**当選・落選者の票は次の候補者に全量移譲されるよう処理する。** |
| `_eliminate_loser` | 最下位の候補者を落選させる。 |
| `_display_final_results` | 最終結果を表示する。 |

---

## 3. テスト計画

### 3.1. テスト方針
- **シナリオテスト（正常系）:** サンプルデータで、通りの期待通りの結果になることを確認済。

### 3.2. テストデータ
- **入力:** `docs/test_votedata.txt` 及び、別途作成するエッジケース用データ。
- **期待結果:** 選挙規約に記載の選挙結果。及び、エッジケースで想定される結果。
